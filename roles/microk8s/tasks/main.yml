- name: adjust cmdline.txt for microk8s
  become: yes
  replace:
      path: /boot/firmware/cmdline.txt
      regexp: '^([\w](?!.*\b{{ item }}\b).*)$'
      replace: '\1 {{ item }}'
  with_items:
    - "cgroup_enable=cpuset"
    - "cgroup_memory=1"
    - "cgroup_enable=memory"
    - "swapaccount=1"

- name: 'install microk8s'
  become: yes
  community.general.snap:
    name: microk8s
    classic: yes

- name: 'set limited containerd logging'
  become: yes
  lineinfile:
    path: /var/snap/microk8s/current/args/containerd
    line: '--log-level fatal'

- name: 'enable microk8s addons'
  become: yes
  command: 'microk8s enable dashboard dns storage registry'
